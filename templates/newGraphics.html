<html>

<canvas id="myCanvas" width="600" height="600"
        style="border:1px solid #000000;">
</canvas>

<script>
//****************************** Set Up ******************************
//Setting up the canvas
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");

//****************************** Variables ******************************
//selectedShape: indicating the shape of next Topic to be created
var selectedShape = "Rectangle";

//clickedTopic: to be replaced by clicking "+" "-" later
var clickedTopic;

//defaultX: default Size and outline color when create new topic
var defaultCenterX = 25;
var defaultCenterY = 25; 
var defaultWidth = 50;
var defaultHeight = 50;
var defaultFont = "15px Arial";
//color
var defaultStroke = "black";

//default color for connection lines
var connectionStroke = "green";

//topics;
var topics = [];

//****************************** Classes ******************************

//Topic (Class) [Model]
//REQUIRES: either initializing the rootTopic or a request has been made
//ENSURES: create an instance of class Topic
function Topic(title,content,rating) {
    var t = {};

    //-------------------- attributes --------------------
    t.centerX = defaultCenterX;
    t.centerY = defaultCenterY;
    t.width = defaultWidth;
    t.height = defaultHeight;
    t.leftX = t.centerX-t.width/2;
    t.leftY = t.centerY-t.height/2;

    t.title = title;
    t.content = content;
    t.rating = rating;
    t.shape = selectedShape;
    t.font = defaultFont;
    //color
    t.stroke = defaultStroke;

    //topics connected to the current one
    //both fathers and sons can be multiple
    t.fathers = [];
    t.sons = [];

    //-------------------- methods --------------------
    //drawing 
    t.drawItself = function() {
        if (t.shape=="Rectangle") {
            //cover connection lines
            ctx.fillStyle = "white";
            ctx.fillRect(t.leftX,t.leftY,t.width,t.height);

            //draw outline 
            ctx.strokeStyle = t.stroke;
            ctx.strokeRect(t.leftX,t.leftY,t.width,t.height);

            //display text
            ctx.font = t.font;
            ctx.textAlign = "center";
            ctx.fillStyle = t.stroke;
            ctx.fillText(t.title,t.centerX,t.centerY);

        };
        return 42;
    };
    t.drawConnectionLines = function() {
        ctx.strokeStyle = connectionStroke;
        for (var i=0;i<t.sons.length;i++) {
            ctx.beginPath();
            ctx.moveTo(t.centerX,t.centerY);
            ctx.lineTo(t.sons[i].centerX,t.sons[i].centerY);
            ctx.stroke();
        };
    };

    //checking
    t.isClickedOn = function(x,y) {
        if (t.shape=="Rectangle") {
            var x0,y0,x1,y1;
            x0,y0 = t.leftX,t.leftY;
            x1,y1 = (x0+t.width),(y0+t.height);
            if ((x0<=x) && (x<=x1) && (y0<=y) && (y<=y1)) {
                return true;
            } else {
                return false;
            };
        };
        return 42;
    };

    //modification
    //connectTo
    //REQUIRES: father topic exists
    //ENSURES: build connection between father and current topic
    //         double ways connection
    t.buildConnectionFrom = function(father) {
        father.sons.push(t);
        t.fathers.push(father);
    };
    t.reposition = function(newCenterX,newCenterY) {
        t.centerX = newCenterX;
        t.centerY = newCenterY;
        t.leftX = newCenterX-t.width/2;
        t.leftY = newCenterY-t.height/2;
    }

    return t;
};
topics.push(Topic("Palace","Start",10));
topics[0].reposition(canvas.width/2,canvas.height/2);

//****************************** Functions ******************************

//findTopic (helper)
//REQUIRES: topic exists
//ENSURES: return the topic object
function findTopic(targetTitle) {
    for (var i=0;i<topics.length;i++) {
        if (topics[i].title == targetTitle) {
            return topics[i];
        }
    };
};

//adjustPosition 
//REQUIRES: A new Topic has been made
//ENSURES: Adjust Position for all topics
function adjustPosition() {
    //reposition the rootTopic
    function adjustSonTopicPosition(father,currTopic) {
        //the number of total branches going in/out from currTopic
        var r = 40;
        var divisor = 1+currTopic.sons.length;
        var dAngle = 2*Math.PI/divisor;
        var angle;
        var startAngle = Math.atan((father.centerY-currTopic.centerY)/
                                   (father.centerX-currTopic.centerX));
        for (var i=0;i<currTopic.sons.length;i++) {
            angle = startAngle + dAngle*i;
            dx = Math.cos(angle)*r;
            dy = Math.sin(angle)*r;
            currTopic.sons[i].reposition(currTopic.centerX+dx,
                                         currTopic.centerY+dy);
            adjustSonTopicPosition(currTopic,currTopic.sons[i]);
        }

    }
    for (var i=0;i<topics[0].sons.length;i++) {
        adjustSonTopicPosition(topics[0],topics[0].sons[i]);
    }
};

//createTopicByRequest
//REQUIRES: a request by user has been made
//ENSURES: create a new topic according to user's request
function createTopicByRequest(topic_name,topic_description,parent_topic,rating) {
    var father = findTopic(parent_topic);
    var currTopic = Topic(topic_name,topic_description,rating);
    currTopic.buildConnectionFrom(father);
    adjustPosition();
};

//redrawAll [View]
//REQUIRES: None
//ENSURES: the canvas is redrawed
function redrawAll() {
    // erase everything -- not efficient, but simple!
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    //First time draw the connection lines
    for (var i=0;i<topics.length;i++) {
        topics[i].drawConnectionLines();
    };
    //Second time draw the topic to cover the extra portion of lines
    for (var i=0;i<topics.length;i++) {
        topics[i].drawItself();
    };
};
//onClick 
//REQUIRES: event mouse clicked happens
//ENSURES: 
function onClick(event) {
    var x = event.pageX - canvas.offsetLeft;  
    var y = event.pageY - canvas.offsetTop;
    
    //start to request user input
//******************************************************************************to be finished
}


//Event Based Animation Wrappers [Controller]
//After processing an event, redraw the canvas
function onClickWrapper(event) {
    onClick(event);
    redrawAll();};

//run
//REQUIRES: None
//ENSURES: Driving function
function run() {
    canvas.addEventListener('click', onClickWrapper, false);
    // make canvas focusable, then give it focus!
    canvas.setAttribute('tabindex','0');
    canvas.focus();
    redrawAll();
};

run();

//test
//REQUIRES: None
//ENSURES: tba
function test() {
    topics.push(Topic("2","...",5));
    topics.push(Topic("3","...",5));
    topics[1].buildConnectionFrom(topics[0]);
    topics[2].buildConnectionFrom(topics[0]);
    adjustPosition();
    console.log(topics[1].centerX,topics[1].centerY);
}
test();
</script>
</html>