var MAPJS=MAPJS||{},observable=function(a){"use strict";var b=[];return a.addEventListener=function(a,c,d){a.split(" ").forEach(function(a){a&&b.push({type:a,listener:c,priority:d||0})})},a.listeners=function(a){return b.filter(function(b){return b.type===a}).map(function(a){return a.listener})},a.removeEventListener=function(a,c){b=b.filter(function(a){return a.listener!==c})},a.dispatchEvent=function(a){var c=Array.prototype.slice.call(arguments,1);b.filter(function(b){return b.type===a}).sort(function(a,b){return b.priority-a.priority}).some(function(a){try{return a.listener.apply(void 0,c)===!1}catch(b){console.log("dispatchEvent failed",b,a)}})},a};MAPJS.URLHelper={urlPattern:/(https?:\/\/|www\.)[\w-]+(\.[\w-]+)+([\w.,!@?^=%&amp;:\/~+#-]*[\w!@?^=%&amp;\/~+#-])?/i,containsLink:function(a){"use strict";return MAPJS.URLHelper.urlPattern.test(a)},getLink:function(a){"use strict";var b=a.match(MAPJS.URLHelper.urlPattern);return b&&b[0]&&(b=b[0],/https?:\/\//i.test(b)||(b="http://"+b)),b},stripLink:function(a){"use strict";return a.replace(MAPJS.URLHelper.urlPattern,"")}},MAPJS.content=function(a,b){"use strict";var c,d=function(){c=void 0},e=function B(b){return b=b||a,b.ideas?_.reduce(b.ideas,function(a,b){return Math.max(a,B(b))},parseInt(b.id,10)||0):parseInt(b.id,10)||0},f=function(a){return a=a||b,c||(c=e()),c+=1,a?c+"."+a:c},g=function(a,b){return a.id?d():a.id=f(b),a.ideas&&_.each(a.ideas,function(c,d){a.ideas[parseFloat(d)]=g(c,b)}),a.title||(a.title=""),a.containsDirectChild=a.findChildRankById=function(b){return parseFloat(_.reduce(a.ideas,function(a,c,d){return c.id==b?d:a},void 0))},a.findSubIdeaById=function(b){var c=_.find(a.ideas,function(a){return a.id==b});return c||_.reduce(a.ideas,function(a,c){return a||c.findSubIdeaById(b)},void 0)},a.find=function(b){var c=b(a)?[_.pick(a,"id","title")]:[];return 0===_.size(a.ideas)?c:_.reduce(a.ideas,function(a,c){return _.union(a,c.find(b))},c)},a.getAttr=function(b){return a.attr&&a.attr[b]?_.clone(a.attr[b]):!1},a.sortedSubIdeas=function(){if(!a.ideas)return[];var b=[],c=_.groupBy(_.map(_.keys(a.ideas),parseFloat),function(a){return a>0}),d=_.sortBy(c[!0],Math.abs).concat(_.sortBy(c[!1],Math.abs));return _.each(d,function(c){b.push(a.ideas[c])}),b},a.traverse=function(b,c){c||b(a),_.each(a.sortedSubIdeas(),function(a){a.traverse(b,c)}),c&&b(a)},a},h=function(a,b){if(b=b||1,0===_.size(a))return 0;var c=_.keys(a);return c.push(0),_.max(_.map(c,parseFloat),function(a){return a*b})},i=function(b){var c,d,e=1;return b.id==a.id&&(d=_.countBy(b.ideas,function(a,b){return 0>b}),(d["true"]||0)<d["false"]&&(e=-1)),c=h(b.ideas,e)+e},j=function(a,b){var c;return a.ideas=a.ideas||{},c=i(a),a.ideas[c]=b,c},k=function(b){return a.id==b?a:a.findSubIdeaById(b)},l=function(a,b){return _(_.map(_.keys(a.ideas),parseFloat)).reject(function(a){return 0>a*b})},m=function(a){return 0>a?-1:1},n={},o={},p=!1,q={},r=function(b,c,d){d?a.dispatchEvent("changed",b,c,d):a.dispatchEvent("changed",b,c)},s=function(b,c,d,e){var f;return"batch"!==b&&!q[e]&&n&&n[e]&&0!==n[e].length?(f=n[e].pop(),"batch"===f.eventMethod?n[e].push({eventMethod:"batch",eventArgs:f.eventArgs.concat([[b].concat(c)]),undoFunction:function(){d(),f.undoFunction()}}):n[e].push({eventMethod:"batch",eventArgs:[[f.eventMethod].concat(f.eventArgs)].concat([[b].concat(c)]),undoFunction:function(){d(),f.undoFunction()}}),void(p?a.dispatchEvent("changed","redo",void 0,e):(r(b,c,e),o[e]=[]))):void t(b,c,d,e)},t=function(b,c,d,e){var f={eventMethod:b,eventArgs:c,undoFunction:d};return q[e]?void q[e].push(f):(n[e]||(n[e]=[]),n[e].push(f),void(p?a.dispatchEvent("changed","redo",void 0,e):(r(b,c,e),o[e]=[])))},u=function(a,b,c){a.ideas[b]=a.ideas[c],delete a.ideas[c]},v=function(a){if(a.style){a.attr={};var b=a.style.collapsed;delete a.style.collapsed,a.attr.style=a.style,b&&(a.attr.collapsed=b),delete a.style}a.ideas&&_.each(a.ideas,v)},w=function(a){var b=String(a).indexOf(".");return b>0&&a.substr(b+1)},x={},y={},z="/xxxxxxxx-yxxx-yxxx-yxxx-xxxxxxxxxxxx/".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})+(b||""),A=function(a,b,c){var d;if(!a)return!1;if(d=_.extend({},a.attr),a.attr=_.extend({},a.attr),!c||"false"===c||_.isObject(c)&&_.isEmpty(c)){if(!a.attr[b])return!1;delete a.attr[b]}else{if(_.isEqual(a.attr[b],c))return!1;a.attr[b]=JSON.parse(JSON.stringify(c))}return 0===_.size(a.attr)&&delete a.attr,function(){a.attr=d}};return a.setConfiguration=function(a){y=a||{}},a.getSessionKey=function(){return b},a.nextSiblingId=function(b){var c,d,e,f=a.findParent(b);return f?(c=f.findChildRankById(b),d=l(f,c),e=_.reject(d,function(a){return Math.abs(a)<=Math.abs(c)}),0===e.length?!1:f.ideas[_.min(e,Math.abs)].id):!1},a.sameSideSiblingIds=function(b){var c=a.findParent(b),d=c.findChildRankById(b);return _.without(_.map(_.pick(c.ideas,l(c,d)),function(a){return a.id}),b)},a.getAttrById=function(a,b){var c=k(a);return c&&c.getAttr(b)},a.previousSiblingId=function(b){var c,d,e,f=a.findParent(b);return f?(c=f.findChildRankById(b),d=l(f,c),e=_.reject(d,function(a){return Math.abs(a)>=Math.abs(c)}),0===e.length?!1:f.ideas[_.max(e,Math.abs)].id):!1},a.clone=function(b){var c=b&&b!=a.id&&a.findSubIdeaById(b)||a;return JSON.parse(JSON.stringify(c))},a.cloneMultiple=function(b){return _.map(b,a.clone)},a.calculatePath=function(b,c,d){return a.id==b?[]:(c=c||[a],d=d||a,d.containsDirectChild(b)?c:_.reduce(d.ideas,function(d,e){return d||a.calculatePath(b,[e].concat(c),e)},!1))},a.getSubTreeIds=function(b){var c=[],d=function(a){return _.isEmpty(a.ideas)?[]:void _.each(a.sortedSubIdeas(),function(a){d(a),c.push(a.id)})};return d(a.findSubIdeaById(b)||a),c},a.findParent=function(b,c){return c=c||a,c.containsDirectChild(b)?c:_.reduce(c.ideas,function(c,d){return c||a.findParent(b,d)},!1)},a.startBatch=function(c){var d=c||b;a.endBatch(c),q[d]=[]},a.endBatch=function(a){var c,d,e,f=a||b,g=q[f];q[f]=void 0,_.isEmpty(g)||(1===_.size(g)?t(g[0].eventMethod,g[0].eventArgs,g[0].undoFunction,f):(c=_.map(g,function(a){return[a.eventMethod].concat(a.eventArgs)}),d=_.sortBy(_.map(g,function(a){return a.undoFunction}),function(a,b){return-1*b}),e=function(){_.each(d,function(a){a()})},t("batch",c,e,f)))},a.execCommand=function(c,d,e){return x[c]?x[c].apply(a,[e||b].concat(_.toArray(d))):!1},a.batch=function(b){a.startBatch();try{b()}finally{a.endBatch()}},x.batch=function(b){a.startBatch(b);try{_.each(_.toArray(arguments).slice(1),function(c){a.execCommand(c[0],c.slice(1),b)})}finally{a.endBatch(b)}},a.pasteMultiple=function(b,c){a.startBatch();var d=_.map(c,function(c){return a.paste(b,c)});return a.endBatch(),d},a.paste=function(b,c,d){return a.execCommand("paste",arguments)},x.paste=function(b,e,f,h){var i,k,l=e==a.id?a:a.findSubIdeaById(e),m=function(a){var b,c,d=_.omit(a,"ideas","id","attr"),e=1;return d.attr=_.omit(a.attr,y.nonClonedAttributes),_.isEmpty(d.attr)&&delete d.attr,a.ideas&&(b=_.groupBy(_.map(_.keys(a.ideas),parseFloat),function(a){return a>0}),c=_.sortBy(b[!0],Math.abs).concat(_.sortBy(b[!1],Math.abs)),d.ideas={},_.each(c,function(b){d.ideas[e++]=m(a.ideas[b])})),d};return h&&(c=parseInt(h,10)-1),i=f&&(f.title||f.attr)&&g(m(f),w(h)),l&&i?(k=j(l,i),h&&d(),A(i,"position"),t("paste",[e,f,i.id],function(){delete l.ideas[k]},b),i.id):!1},a.flip=function(b){return a.execCommand("flip",arguments)},x.flip=function(b,c){var d,e,f=a.findChildRankById(c);return f?(e=h(a.ideas,-1*m(f)),d=e-10*m(f),u(a,d,f),t("flip",[c],function(){u(a,f,d)},b),!0):!1},a.initialiseTitle=function(b,c){return a.execCommand("initialiseTitle",arguments)},x.initialiseTitle=function(a,b,c){var d,e=k(b);return e?(d=e.title,d==c?!1:(e.title=c,s("initialiseTitle",[b,c],function(){e.title=d},a),!0)):!1},a.updateTitle=function(b,c){return a.execCommand("updateTitle",arguments)},x.updateTitle=function(a,b,c){var d,e=k(b);return e?(d=e.title,d==c?!1:(e.title=c,t("updateTitle",[b,c],function(){e.title=d},a),!0)):!1},a.addSubIdea=function(b,c,d){return a.execCommand("addSubIdea",arguments)},x.addSubIdea=function(a,b,c,d){var e,f,h=k(b);return h?d&&k(d)?!1:(e=g({title:c,id:d}),f=j(h,e),t("addSubIdea",[b,c,e.id],function(){delete h.ideas[f]},a),e.id):!1},a.removeMultiple=function(b){a.startBatch();var c=_.map(b,a.removeSubIdea);return a.endBatch(),c},a.removeSubIdea=function(b){return a.execCommand("removeSubIdea",arguments)},x.removeSubIdea=function(b,c){var d,e,f,g=a.findParent(c);return g?(d=g.findChildRankById(c),e=g.ideas[d],delete g.ideas[d],f=a.links,a.links=_.reject(a.links,function(a){return a.ideaIdFrom==c||a.ideaIdTo==c}),t("removeSubIdea",[c],function(){g.ideas[d]=e,a.links=f},b),!0):!1},a.insertIntermediateMultiple=function(b){a.startBatch();var c=a.insertIntermediate(b[0]);return _.each(b.slice(1),function(b){a.changeParent(b,c)}),a.endBatch(),c},a.insertIntermediate=function(b,c,d){return a.execCommand("insertIntermediate",arguments)},x.insertIntermediate=function(b,c,d,e){if(a.id==c)return!1;var f,h,i,j=a.findParent(c);return j?e&&k(e)?!1:(f=j.findChildRankById(c))?(h=j.ideas[f],i=g({title:d,id:e}),j.ideas[f]=i,i.ideas={1:h},t("insertIntermediate",[c,d,i.id],function(){j.ideas[f]=h},b),i.id):!1:!1},a.changeParent=function(b,c){return a.execCommand("changeParent",arguments)},x.changeParent=function(b,c,d){var e,f,g,h,i,l=k(d);return c==d?!1:l&&(h=a.findSubIdeaById(c))?h.findSubIdeaById(d)?!1:l.containsDirectChild(c)?!1:(e=a.findParent(c))?(f=e.findChildRankById(c),g=j(l,h),i=h.getAttr("position"),A(h,"position"),delete e.ideas[f],t("changeParent",[c,d],function(){A(h,"position",i),e.ideas[f]=h,delete l.ideas[g]},b),!0):!1:!1},a.mergeAttrProperty=function(b,c,d,e){var f=a.getAttrById(b,c)||{};return e?f[d]=e:delete f[d],_.isEmpty(f)&&(f=!1),a.updateAttr(b,c,f)},a.updateAttr=function(b,c,d){return a.execCommand("updateAttr",arguments)},x.updateAttr=function(a,b,c,d){var e,f=k(b);return e=A(f,c,d),e&&t("updateAttr",[b,c,d],e,a),!!e},a.moveRelative=function(b,c){var d=a.findParent(b),e=d&&d.findChildRankById(b),f=e&&_.sortBy(l(d,e),Math.abs),g=f&&f.indexOf(e),h=g+(c>0?c+1:c),i=h>=0&&d&&f&&d.ideas[f[h]];return 0>h||!d?!1:a.positionBefore(b,i&&i.id,d)},a.positionBefore=function(b,c,d){return a.execCommand("positionBefore",arguments)},x.positionBefore=function(b,c,d,e){e=e||a;var f,g,i,j,k,m,n;if(n=e.findChildRankById(c),!n)return _.reduce(e.ideas,function(a,e){return a||x.positionBefore(b,c,d,e)},!1);if(c==d)return!1;if(f=0,d){if(g=e.findChildRankById(d),!g)return!1;if(i=l(e,n),j=_.reject(_.sortBy(i,Math.abs),function(a){return Math.abs(a)>=Math.abs(g)}),k=j.length>0?_.max(j,Math.abs):0,k==n)return!1;f=k+(g-k)/2}else{if(m=h(e.ideas,0>n?-1:1),m==n)return!1;f=m+10*(0>n?-1:1)}return f==n?!1:(u(e,f,n),t("positionBefore",[c,d],function(){u(e,n,f)},b),!0)},observable(a),function(){var b=function(a,b){var c,d,e;return a===b?!1:(d=k(a))&&(e=k(b))?(c=_.find(d.ideas,function(a){return a.id===b})||_.find(e.ideas,function(b){return b.id===a}),c?!1:!0):!1};a.addLink=function(b,c){return a.execCommand("addLink",arguments)},x.addLink=function(c,d,e){var f,g;return b(d,e)?(f=_.find(a.links,function(a){return a.ideaIdFrom===d&&a.ideaIdTo===e||a.ideaIdFrom===e&&a.ideaIdTo===d}))?!1:(a.links=a.links||[],g={ideaIdFrom:d,ideaIdTo:e,attr:{style:{color:"#FF0000",lineStyle:"dashed"}}},a.links.push(g),t("addLink",[d,e],function(){a.links.pop()},c),!0):!1},a.removeLink=function(b,c){return a.execCommand("removeLink",arguments)},x.removeLink=function(b,c,d){for(var e,f=0;a.links&&f<a.links.length;){if(e=a.links[f],String(e.ideaIdFrom)===String(c)&&String(e.ideaIdTo)===String(d))return a.links.splice(f,1),t("removeLink",[c,d],function(){a.links.push(_.clone(e))},b),!0;f+=1}return!1},a.getLinkAttr=function(b,c,d){var e=_.find(a.links,function(a){return a.ideaIdFrom==b&&a.ideaIdTo==c});return e&&e.attr&&e.attr[d]?e.attr[d]:!1},a.updateLinkAttr=function(b,c,d,e){return a.execCommand("updateLinkAttr",arguments)},x.updateLinkAttr=function(b,c,d,e,f){var g,h=_.find(a.links,function(a){return a.ideaIdFrom==c&&a.ideaIdTo==d});return g=A(h,e,f),g&&t("updateLinkAttr",[c,d,e,f],g,b),!!g}}(),a.canUndo=function(){return!!(n[b]&&n[b].length>0)},a.canRedo=function(){return!!(o[b]&&o[b].length>0)},a.undo=function(){return a.execCommand("undo",arguments)},x.undo=function(b){a.endBatch();var c;return c=n[b]&&n[b].pop(),c&&c.undoFunction?(c.undoFunction(),o[b]||(o[b]=[]),o[b].push(c),a.dispatchEvent("changed","undo",[],b),!0):!1},a.redo=function(){return a.execCommand("redo",arguments)},x.redo=function(b){a.endBatch();var c;return c=o[b]&&o[b].pop(),c?(p=!0,a.execCommand(c.eventMethod,c.eventArgs,b),p=!1,!0):!1},a.storeResource=function(){return a.execCommand("storeResource",arguments)},x.storeResource=function(c,d,e){var f,g,h=function(){if(_.isEmpty(a.resources))return 0;var c=function(a){return parseInt(a,10)},d=_.keys(a.resources),e=b?_.filter(d,RegExp.prototype.test.bind(new RegExp("\\/"+b+"$"))):d,f=_.map(e,c);return _.isEmpty(f)?0:_.max(f)},i=function(){var a=h()+1;return a+z};return!e&&a.resources&&(f=_.find(_.keys(a.resources),function(b){return a.resources[b]===d}))?f:(g=e||i(),a.resources=a.resources||{},a.resources[g]=d,a.dispatchEvent("resourceStored",d,g,c),g)},a.getResource=function(b){return a.resources&&a.resources[b]},a.hasSiblings=function(b){if(b===a.id)return!1;var c=a.findParent(b);return c&&_.size(c.ideas)>1},2!=a.formatVersion&&(v(a),a.formatVersion=2),g(a),a},MAPJS.defaultStyles={},MAPJS.layoutLinks=function(a,b){"use strict";var c={};return _.each(a.links,function(a){b[a.ideaIdFrom]&&b[a.ideaIdTo]&&(c[a.ideaIdFrom+"_"+a.ideaIdTo]={ideaIdFrom:a.ideaIdFrom,ideaIdTo:a.ideaIdTo,attr:_.clone(a.attr)})}),c},MAPJS.calculateFrame=function(a,b){"use strict";b=b||0;var c={top:_.min(a,function(a){return a.y}).y-b,left:_.min(a,function(a){return a.x}).x-b};return c.width=b+_.max(_.map(a,function(a){return a.x+a.width}))-c.left,c.height=b+_.max(_.map(a,function(a){return a.y+a.height}))-c.top,c},MAPJS.contrastForeground=function(a){"use strict";var b=Color(a).luminosity();return.5>b?"#EEEEEE":.9>b?"#4F4F4F":"#000000"},MAPJS.Outline=function(a,b){"use strict";var c=function(a,b){return _.map(a,function(a){return{l:a.l,h:a.h+b}})};this.initialHeight=function(){return this.bottom[0].h-this.top[0].h},this.borders=function(){return _.pick(this,"top","bottom")},this.spacingAbove=function(a){for(var b=0,c=0,d=0,e=0,f=0;b<this.bottom.length&&c<a.top.length;)d=Math.max(d,this.bottom[b].h-a.top[c].h),e+this.bottom[b].l<f+a.top[c].l?(e+=this.bottom[b].l,b+=1):e+this.bottom[b].l===f+a.top[c].l?(e+=this.bottom[b].l,b+=1,f+=a.top[c].l,c+=1):(f+=a.top[c].l,c+=1);return d},this.indent=function(a,b){if(!a)return this;var c=this.top.slice(),d=this.bottom.slice(),e=(d[0].h+c[0].h)/2;return c.unshift({h:e-b/2,l:a}),d.unshift({h:e+b/2,l:a}),new MAPJS.Outline(c,d)},this.stackBelow=function(a,b){var d=a.spacingAbove(this),e=MAPJS.Outline.extendBorder(a.top,c(this.top,d+b)),f=MAPJS.Outline.extendBorder(c(this.bottom,d+b),a.bottom);return new MAPJS.Outline(e,f)},this.expand=function(a,b){var d=a-this.top[0].h,e=b-this.bottom[0].h,f=c(this.top,d),g=c(this.bottom,e);return new MAPJS.Outline(f,g)},this.insertAtStart=function(a,b){var d=0,e=c(this.top,d),f=c(this.bottom,d),g=function(a){a[0].l*=.5,a[1].l+=a[0].l};return e[0].l+=b,f[0].l+=b,e.unshift({h:-.5*a.height,l:a.width}),f.unshift({h:.5*a.height,l:a.width}),e[0].h>e[1].h&&g(e),f[0].h<f[1].h&&g(f),new MAPJS.Outline(e,f)},this.top=a.slice(),this.bottom=b.slice()},MAPJS.Outline.borderLength=function(a){"use strict";return _.reduce(a,function(a,b){return a+b.l},0)},MAPJS.Outline.borderSegmentIndexAt=function(a,b){"use strict";for(var c=0,d=-1;b>=c;){if(d+=1,d>=a.length)return-1;c+=a[d].l}return d},MAPJS.Outline.extendBorder=function(a,b){"use strict";var c,d=a.slice(),e=MAPJS.Outline.borderLength(a),f=MAPJS.Outline.borderSegmentIndexAt(b,e);return f>=0&&(c=MAPJS.Outline.borderLength(b.slice(0,f+1)),d.push({h:b[f].h,l:c-e}),d=d.concat(b.slice(f+1))),d},MAPJS.Tree=function(a){"use strict";_.extend(this,a),this.toLayout=function(a,b,c){a=a||0,b=b||0;var d,e={nodes:{},connectors:{}};return d=_.pick(this,"id","title","attr","width","height","level"),1===d.level?(d.x=-.5*this.width,d.y=-.5*this.height):(d.x=a+this.deltaX||0,d.y=b+this.deltaY||0),e.nodes[this.id]=d,void 0!==c&&(e.connectors[d.id]={from:c,to:d.id}),this.subtrees&&this.subtrees.forEach(function(a){var b=a.toLayout(d.x,d.y,d.id);_.extend(e.nodes,b.nodes),_.extend(e.connectors,b.connectors)}),e}},MAPJS.Outline.fromDimensions=function(a){"use strict";return new MAPJS.Outline([{h:-.5*a.height,l:a.width}],[{h:.5*a.height,l:a.width}])},MAPJS.calculateTree=function(a,b,c,d,e){"use strict";var f={id:a.id,title:a.title,attr:a.attr,deltaY:0,deltaX:0,level:e||1},g=function(a,b){var c,d,e,f,g,h,i=_.map(a,function(a){return _.pick(a,"deltaX","deltaY")});for(c=0;c<a.length;c+=1)d=a[c],d.attr&&d.attr.position?(d.deltaY=d.attr.position[1],(void 0===g||d.attr.position[2]>a[g].attr.position[2])&&(g=c)):d.deltaY+=b,c>0&&(e=i[c].deltaY-i[c-1].deltaY,f=a[c].deltaY-a[c-1].deltaY,e>f&&(d.deltaY+=e-f));if(h=g&&a[g].attr.position[1]-a[g].deltaY)for(c=0;c<a.length;c+=1)a[c].deltaY+=h},h=function(){return!(_.isEmpty(a.ideas)||a.attr&&a.attr.collapsed)},i=function(){var b=_.map(_.keys(a.ideas),parseFloat),c=d?_.filter(b,function(b){return d(b,a.id)}):b;return _.sortBy(c,Math.abs)},j=function(){var b=[];return _.each(i(),function(c){b.push(a.ideas[c])}),b},k=b(a,f.level),l=function(a){var b,d,e,h,i;_.each(a,function(a){a.deltaX=k.width+c,e=a.attr&&a.attr.position&&a.attr.position[0],e&&e>a.deltaX?(h=e-a.deltaX,a.deltaX=e):h=0,b?(i=a.outline.indent(h,c),d=i.initialHeight(),b=i.stackBelow(b,c),a.deltaY=b.initialHeight()-d/2-a.height/2):b=a.outline.indent(h,c)}),a&&a.length&&(g(a,.5*(k.height-b.initialHeight())),b=b.expand(a[0].deltaY-.5*k.height,a[a.length-1].deltaY+a[a.length-1].height-.5*k.height)),f.outline=b.insertAtStart(k,c)};return _.extend(f,k),f.outline=new MAPJS.Outline.fromDimensions(k),h()&&(f.subtrees=_.map(j(),function(a){return MAPJS.calculateTree(a,b,c,d,f.level+1)}),_.isEmpty(f.subtrees)||l(f.subtrees)),new MAPJS.Tree(f)},MAPJS.calculateLayout=function(a,b,c){"use strict";var d,e,f,g,h=function(a){_.each(a,function(a){a.attr=a.attr||{},a.attr.style=_.extend({},MAPJS.defaultStyles[1===a.level?"root":"nonRoot"],a.attr.style)})},i=function(b,c){return c!==a.id||b>0},j=function(b,c){return c!==a.id||0>b};return c=c||20,d=MAPJS.calculateTree(a,b,c,i),e=MAPJS.calculateTree(a,b,c,j),f=d.toLayout(),g=e.toLayout(),_.each(g.nodes,function(a){a.x=-1*a.x-a.width}),_.extend(g.nodes,f.nodes),_.extend(g.connectors,f.connectors),h(g.nodes),g.links=MAPJS.layoutLinks(a,g.nodes),g.rootNodeId=a.id,g},MAPJS.MemoryClipboard=function(){"use strict";var a,b=this,c=function(a){return a?JSON.parse(JSON.stringify(a)):void 0};b.get=function(){return c(a)},b.put=function(b){a=c(b)}},function(){"use strict";$.fn.simpleDraggableContainer=function(){var a,b,c=this,d=function(c){if(a&&c.gesture){var d={top:Math.round(parseInt(b.top,10)+c.gesture.deltaY),left:Math.round(parseInt(b.left,10)+c.gesture.deltaX)};return a.css(d).trigger($.Event("mm:drag",{currentPosition:d,gesture:c.gesture})),c.gesture&&c.gesture.preventDefault(),!1}},e=function(c){var d=a;"shadow"!==d.attr("mapjs-drag-role")?d.animate(b,{complete:function(){d.trigger($.Event("mm:cancel-dragging",{gesture:c.gesture}))},progress:function(){d.trigger("mm:drag")}}):d.trigger($.Event("mm:cancel-dragging",{gesture:c.gesture}))};return Hammer(this,{drag_min_distance:2}),this.on("mm:start-dragging",function(c){a||(a=$(c.relatedTarget),b={top:a.css("top"),left:a.css("left")},$(this).on("drag",d))}).on("mm:start-dragging-shadow",function(e){var f=$(e.relatedTarget),g=function(){var a=f.clone().addClass("drag-shadow").appendTo(c).offset(f.offset()).data(f.data()).attr("mapjs-drag-role","shadow"),b=f.parent().data("scale")||1;return 0!==b&&a.css({transform:"scale("+b+")","transform-origin":"top left"}),a};a||(a=g(),b={top:a.css("top"),left:a.css("left")},a.on("mm:stop-dragging mm:cancel-dragging",function(a){this.remove(),a.stopPropagation(),a.stopImmediatePropagation();var b=$.Event(a.type,{gesture:a.gesture,finalPosition:a.finalPosition});f.trigger(b)}).on("mm:drag",function(a){f.trigger(a)}),$(this).on("drag",d))}).on("dragend",function(b){if($(this).off("drag",d),a){var c=$.Event("mm:stop-dragging",{gesture:b.gesture,finalPosition:a.offset()});a.trigger(c),c.result===!1&&e(b),a=void 0}}).on("mouseleave",function(b){a&&($(this).off("drag",d),e(b),a=void 0)}).attr("data-drag-role","container")};var a=function(a){$(this).trigger($.Event("mm:start-dragging",{relatedTarget:this,gesture:a.gesture})),a.stopPropagation(),a.preventDefault(),a.gesture&&(a.gesture.stopPropagation(),a.gesture.preventDefault())},b=function(a){$(this).trigger($.Event("mm:start-dragging-shadow",{relatedTarget:this,gesture:a.gesture})),a.stopPropagation(),a.preventDefault(),a.gesture&&(a.gesture.stopPropagation(),a.gesture.preventDefault())};$.fn.simpleDraggable=function(b){return b&&b.disable?$(this).off("dragstart",a):$(this).on("dragstart",a)},$.fn.shadowDraggable=function(a){return a&&a.disable?$(this).off("dragstart",b):$(this).on("dragstart",b)}}(),MAPJS.MapModel=function(a,b,c,d){"use strict";var e,f,g,h,i,j,k,l=this,m=a,n=d||20,o=c||new MAPJS.MemoryClipboard,p={nodes:{},connectors:{}},q=!0,r=!0,s=[],t=function(a){var b=_.clone(s);s=0===a.length?[h]:a,l.dispatchEvent("activatedNodesChanged",_.difference(s,b),_.difference(b,s))},u=300,v=function(a){var b;g&&(b=g(f),_.each(a.nodes,function(a,c){(b[c]||0===b[c])&&(a.label=b[c])}))},w=function(a,b){l.dispatchEvent("layoutChangeStarting",_.size(a.nodes)-_.size(p.nodes)),v(a),_.each(p.connectors,function(b,c){var d=a.connectors[c];d&&d.from===b.from&&d.to===b.to||l.dispatchEvent("connectorRemoved",b)}),_.each(p.links,function(b,c){var d=a.links&&a.links[c];d||l.dispatchEvent("linkRemoved",b)}),_.each(p.nodes,function(c,d){var e,g=a.nodes[d];g||(d==h&&l.selectNode(f.id),e=_.reject(s,function(a){return a==d}),e.length!==s.length&&t(e),l.dispatchEvent("nodeRemoved",c,d,b))}),_.each(a.nodes,function(a,c){var d=p.nodes[c];d?((a.x!==d.x||a.y!==d.y)&&l.dispatchEvent("nodeMoved",a,b),a.title!==d.title&&l.dispatchEvent("nodeTitleChanged",a,b),_.isEqual(a.attr||{},d.attr||{})||l.dispatchEvent("nodeAttrChanged",a,b),a.label!==d.label&&l.dispatchEvent("nodeLabelChanged",a,b)):l.dispatchEvent("nodeCreated",a,b)}),_.each(a.connectors,function(a,c){var d=p.connectors[c];d&&a.from===d.from&&a.to===d.to||l.dispatchEvent("connectorCreated",a,b)}),_.each(a.links,function(a,c){var d=p.links&&p.links[c];d?_.isEqual(a.attr||{},d&&d.attr||{})||l.dispatchEvent("linkAttrChanged",a,b):l.dispatchEvent("linkCreated",a,b)}),p=a,l.isInCollapse||l.dispatchEvent("layoutChangeComplete")},x=function(a){j=h,k=s.slice(0),l.selectNode(a)},y=function(a){x(a),l.editNode(!1,!0,!0)},z=function(){return h||f.id},A=!1,B=function(a,b,c){A||(j=!1,k=!1,l.rebuildRequired(c))},C=function(){return f.findSubIdeaById(h)||f},D=function(a,b){var c=f.findSubIdeaById(b)||f;c.getAttr("collapsed")&&f.updateAttr(b,"collapsed",!1)};observable(this),e=l.dispatchEvent.bind(l,"analytic","mapModel"),l.pause=function(){A=!0},l.resume=function(){A=!1,l.rebuildRequired()},l.getIdea=function(){return f},l.isEditingEnabled=function(){return r},l.getCurrentLayout=function(){return p},l.analytic=e,l.getCurrentlySelectedIdeaId=z,l.rebuildRequired=function(a){f&&w(l.reactivate(m(f)),a)},this.setIdea=function(a){f&&(f.removeEventListener("changed",B),A=!1,t([]),l.dispatchEvent("nodeSelectionChanged",h,!1),h=void 0),f=a,f.addEventListener("changed",B),B(),l.selectNode(f.id,!0),l.dispatchEvent("mapViewResetRequested")},this.setEditingEnabled=function(a){r=a},this.getEditingEnabled=function(){return r},this.setInputEnabled=function(a,b){q!==a&&(q=a,l.dispatchEvent("inputEnabledChanged",a,!!b))},this.getInputEnabled=function(){return q},this.selectNode=function(a,b,c){(b||q&&(a!==h||!l.isActivated(a)))&&(h&&l.dispatchEvent("nodeSelectionChanged",h,!1),h=a,c?l.activateNode("internal",a):t([a]),l.dispatchEvent("nodeSelectionChanged",a,!0))},this.clickNode=function(a,b){var c=b&&b.button&&-1!==b.button;b&&b.altKey?l.toggleLink("mouse",a):b&&b.shiftKey?l.toggleActivationOnNode("mouse",a):i&&!c?(this.toggleLink("mouse",a),this.toggleAddLinkMode()):(this.selectNode(a),c&&-1!==c&&q&&l.dispatchEvent("contextMenuRequested",a,b.layerX,b.layerY))},this.findIdeaById=function(a){return f.id==a?f:f.findSubIdeaById(a)},this.getSelectedStyle=function(a){return this.getStyleForId(h,a)},this.getStyleForId=function(a,b){var c=p.nodes&&p.nodes[a];return c&&c.attr&&c.attr.style&&c.attr.style[b]},this.toggleCollapse=function(a){var b,c=C();b=l.isActivated(c.id)&&_.size(c.ideas)>0?c.getAttr("collapsed"):l.everyActivatedIs(function(a){var b=l.findIdeaById(a);return b&&_.size(b.ideas)>0?b.getAttr("collapsed"):!0}),this.collapse(a,!b)},this.collapse=function(a,b){var c,d,g=z(),h=function(){return g&&p&&p.nodes&&p.nodes[g]},i=function(a,b,c){(b||c)&&_.each(a,function(a){a.x+=b,a.y+=c,l.dispatchEvent("nodeMoved",a,"scroll")})};e("collapse:"+b,a),l.isInCollapse=!0,c=h(),q&&l.applyToActivated(function(a){var c=l.findIdeaById(a);c&&(!b||c.ideas&&_.size(c.ideas)>0)&&f.updateAttr(a,"collapsed",b)}),d=h(),c&&d&&i(p.nodes,c.x-d.x,c.y-d.y),l.isInCollapse=!1,l.dispatchEvent("layoutChangeComplete")},this.updateStyle=function(a,b,c){return r?void(q&&(e("updateStyle:"+b,a),l.applyToActivated(function(a){l.getStyleForId(a,b)!=c&&f.mergeAttrProperty(a,"style",b,c)}))):!1},this.updateLinkStyle=function(a,b,c,d,g){var h=_.extend({},f.getLinkAttr(b,c,"style"));return r?void(q&&(e("updateLinkStyle:"+d,a),h[d]=g,f.updateLinkAttr(b,c,"style",h))):!1},this.addSubIdea=function(a,b,c){var d,g=b||h;return r?(e("addSubIdea",a),void(q&&(f.batch(function(){D(a,g),d=c?f.addSubIdea(g,c):f.addSubIdea(g)}),d&&(c?x(d):y(d))))):!1},this.insertIntermediate=function(a){var b,c=[];return r&&q&&h!==f.id?(e("insertIntermediate",a),l.applyToActivated(function(a){c.push(a)}),b=f.insertIntermediateMultiple(c),void(b&&y(b))):!1},this.flip=function(a){var b=p&&p.nodes&&p.nodes[h];return r?(e("flip",a),q&&h!==f.id&&b&&2===b.level?f.flip(h):!1):!1},this.addSiblingIdeaBefore=function(a){var b,c,d,g;return r?(e("addSiblingIdeaBefore",a),q?(c=f.findParent(h)||f,f.batch(function(){D(a,c.id),b=f.addSubIdea(c.id),b&&h!==f.id&&(d=c.findChildRankById(h),g=c.findChildRankById(b),0>d*g&&f.flip(b),f.positionBefore(b,h))}),void(b&&y(b))):!1):!1},this.addSiblingIdea=function(a,b,c){var d,g,i,j,k,l;return l=b||h,r?(e("addSiblingIdea",a),void(q&&(i=f.findParent(l)||f,f.batch(function(){D(a,i.id),d=c?f.addSubIdea(i.id,c):f.addSubIdea(i.id),d&&l!==f.id&&(g=f.nextSiblingId(l),j=i.findChildRankById(l),k=i.findChildRankById(d),0>j*k&&f.flip(d),g&&f.positionBefore(d,g))}),d&&(c?x(d):y(d))))):!1},this.removeSubIdea=function(a){var b;return r?(e("removeSubIdea",a),q&&l.applyToActivated(function(a){var c;h==a&&(c=f.findParent(h),c&&l.selectNode(c.id)),b=f.removeSubIdea(a)}),b):!1},this.updateTitle=function(a,b,c){c?f.initialiseTitle(a,b):f.updateTitle(a,b)},this.editNode=function(a,c,d){var f;return r?(a&&e("editNode",a),q?(f=C().title,_.include(b,f)&&(c=!0),void l.dispatchEvent("nodeEditRequested",h,c,!!d)):!1):!1},this.editIcon=function(a){return r?(a&&e("editIcon",a),q?void l.dispatchEvent("nodeIconEditRequested",h):!1):!1},this.scaleUp=function(a){l.scale(a,1.25)},this.scaleDown=function(a){l.scale(a,.8)},this.scale=function(a,b,c){q&&(l.dispatchEvent("mapScaleChanged",b,c),e(1>b?"scaleDown":"scaleUp",a))},this.move=function(a,b,c){q&&(l.dispatchEvent("mapMoveRequested",b,c),e("move",a))},this.resetView=function(a){q&&(l.selectNode(f.id),l.dispatchEvent("mapViewResetRequested"),e("resetView",a))},this.openAttachment=function(a,b){var c,d;e("openAttachment",a),b=b||h,c=p&&p.nodes&&p.nodes[b],d=c&&c.attr&&c.attr.attachment,c&&l.dispatchEvent("attachmentOpened",b,d)},this.setAttachment=function(a,b,c){var d=!(!c||!c.content);return r?(e("setAttachment",a),void f.updateAttr(b,"attachment",d&&c)):!1},this.toggleLink=function(a,b){var c=_.find(f.links,function(a){return String(a.ideaIdFrom)===String(b)&&String(a.ideaIdTo)===String(h)||String(a.ideaIdTo)===String(b)&&String(a.ideaIdFrom)===String(h)});c?l.removeLink(a,c.ideaIdFrom,c.ideaIdTo):l.addLink(a,b)},this.addLink=function(a,b){return r?(e("addLink",a),void f.addLink(h,b)):!1},this.selectLink=function(a,b,c){return r?(e("selectLink",a),b?void l.dispatchEvent("linkSelected",b,c,f.getLinkAttr(b.ideaIdFrom,b.ideaIdTo,"style")):!1):!1},this.removeLink=function(a,b,c){return r?(e("removeLink",a),void f.removeLink(b,c)):!1},this.toggleAddLinkMode=function(a){return r&&q?(e("toggleAddLinkMode",a),i=!i,void l.dispatchEvent("addLinkModeToggled",i)):!1},this.cancelCurrentAction=function(a){return q&&r?void(i&&this.toggleAddLinkMode(a)):!1},l.undo=function(a){var b=j,c=k;return r?(e("undo",a),void(q&&(f.undo(),b&&l.selectNode(b),c&&t(c)))):!1},l.redo=function(a){return r?(e("redo",a),void(q&&f.redo())):!1},l.moveRelative=function(a,b){return r?(e("moveRelative",a),void(q&&f.moveRelative(h,b))):!1},l.cut=function(a){var b,c=[],d=[];return r?(e("cut",a),void(q&&(l.applyToActivated(function(a){c.push(a),d.push(f.findParent(a).id)}),o.put(f.cloneMultiple(c)),f.removeMultiple(c),b=_.find(d,f.findSubIdeaById),l.selectNode(b||f.id)))):!1},l.contextForNode=function(a){var b=l.findIdeaById(a),c=b&&b.ideas&&_.size(b.ideas)>0,d=f.hasSiblings(a),e=b&&b.getAttr("collapsed"),g=b&&r&&o&&o.get();return b?{hasChildren:!!c,hasSiblings:!!d,canPaste:!!g,notRoot:f.id!=a,canUndo:f.canUndo(),canRedo:f.canRedo(),canCollapse:c&&!e,canExpand:c&&e}:void 0},l.copy=function(a){var b=[];return r?(e("copy",a),void(q&&(l.applyToActivated(function(a){b.push(a)}),o.put(f.cloneMultiple(b))))):!1},l.paste=function(a){var b;return r?(e("paste",a),void(q&&(b=f.pasteMultiple(h,o.get()),b&&b[0]&&l.selectNode(b[0])))):!1},l.pasteStyle=function(a){var b,c=o.get();return r?(e("pasteStyle",a),void(q&&c&&c[0]&&(b=c[0].attr&&c[0].attr.style,l.applyToActivated(function(a){f.updateAttr(a,"style",b)})))):!1},l.getIcon=function(a){var b=p.nodes[a||h];return b?b.attr&&b.attr.icon:!1},l.setIcon=function(a,b,c,d,g,i,j){var k,m;return r?(e("setIcon",a),i=i||h,(k=l.findIdeaById(i))?void(b?(m={url:b,width:c,height:d,position:g},j&&(m.metaData=j),f.updateAttr(i,"icon",m)):k.title||i===f.id?f.updateAttr(i,"icon",!1):f.removeSubIdea(i)):!1):!1},l.moveUp=function(a){l.moveRelative(a,-1)},l.moveDown=function(a){l.moveRelative(a,1)},l.getSelectedNodeId=function(){return z()},l.centerOnNode=function(a){p.nodes[a]||(f.startBatch(),_.each(f.calculatePath(a),function(a){f.updateAttr(a.id,"collapsed",!1)}),f.endBatch()),l.dispatchEvent("nodeFocusRequested",a),l.selectNode(a)},l.search=function(a){var b=[];return a=a.toLocaleLowerCase(),f.traverse(function(c){c.title&&c.title.toLocaleLowerCase().indexOf(a)>=0&&b.push({id:c.id,title:c.title})}),b},function(){var a=function(a){return p.nodes[a].x>=p.nodes[f.id].x},b=function(a){return p.nodes[a].x<=p.nodes[f.id].x},c=function(){return _.map(p.nodes,function(a,b){return _.extend({id:parseInt(b,10)},a)})},d=function(a,c,d){var g,i,j=h===f.id,k=j?-(1/0):1/0;if(q)if(e(c,a),b(h)){g=f.id===h?f:f.findSubIdeaById(h),D(a,g.id);for(i in g.ideas)i=parseFloat(i),(j&&0>i&&i>k||!j&&i>0&&k>i)&&(k=i);k!==1/0&&k!==-(1/0)&&d.apply(l,[g.ideas[k].id])}else d.apply(l,[f.findParent(h).id])},g=function(b,c,d){var g,i,j=1/0;if(q)if(e(c,b),a(h)){g=f.id===h?f:f.findSubIdeaById(h),D(b,g.id);for(i in g.ideas)i=parseFloat(i),i>0&&j>i&&(j=i);j!==1/0&&d.apply(l,[g.ideas[j].id])}else d.apply(l,[f.findParent(h).id])},i=function(a,b,d){var g,i,j=f.previousSiblingId(h),k=p.nodes[h];if(q)if(e(b,a),j)d.apply(l,[j]);else{if(!k)return;if(g=_.reject(c(),function(a){return a.y>=k.y||Math.abs(a.x-k.x)>u}),0===_.size(g))return;i=_.min(g,function(a){return Math.pow(a.x-k.x,2)+Math.pow(a.y-k.y,2)}),d.apply(l,[i.id])}},j=function(a,b,d){var g,i,j=f.nextSiblingId(h),k=p.nodes[h];if(q)if(e(b,a),j)d.apply(l,[j]);else{
if(!k)return;if(g=_.reject(c(),function(a){return a.y<=k.y||Math.abs(a.x-k.x)>u}),0===_.size(g))return;i=_.min(g,function(a){return Math.pow(a.x-k.x,2)+Math.pow(a.y-k.y,2)}),d.apply(l,[i.id])}},k={Left:d,Up:i,Down:j,Right:g};l.getActivatedNodeIds=function(){return s.slice(0)},l.activateSiblingNodes=function(a){var b,c=f.findParent(h);e("activateSiblingNodes",a),c&&c.ideas&&(b=_.map(c.ideas,function(a){return a.id}),t(b))},l.activateNodeAndChildren=function(a){var b=z(),c=f.getSubTreeIds(b);e("activateNodeAndChildren",a),c.push(b),t(c)},_.each(["Left","Right","Up","Down"],function(a){l["activateNode"+a]=function(b){k[a](b,"activateNode"+a,function(a){l.selectNode(a,!1,!0)})},l["selectNode"+a]=function(b){k[a](b,"selectNode"+a,l.selectNode)}}),l.toggleActivationOnNode=function(a,b){e("toggleActivated",a),t(l.isActivated(b)?_.without(s,b):[b].concat(s))},l.activateNode=function(a,b){e("activateNode",a),l.isActivated(b)||(s.push(b),l.dispatchEvent("activatedNodesChanged",[b],[]))},l.activateChildren=function(a){var b=C();e("activateChildren",a),!b||_.isEmpty(b.ideas)||b.getAttr("collapsed")||t(f.getSubTreeIds(b.id))},l.activateSelectedNode=function(a){e("activateSelectedNode",a),t([z()])},l.isActivated=function(a){return _.find(s,function(b){return a==b})},l.applyToActivated=function(a){f.batch(function(){_.each(s,a)})},l.everyActivatedIs=function(a){return _.every(s,a)},l.activateLevel=function(a,b){var c=_.map(_.filter(p.nodes,function(a){return a.level==b}),function(a){return a.id});e("activateLevel",a),_.isEmpty(c)||t(c)},l.reactivate=function(a){return _.each(a.nodes,function(a){_.contains(s,a.id)&&(a.activated=!0)}),a}}(),l.getNodeIdAtPosition=function(a,b){var c=function(c){return a>=c.x&&b>=c.y&&a<=c.x+c.width&&b<=c.y+c.height},d=_.find(p.nodes,c);return d&&d.id},l.autoPosition=function(a){return f.updateAttr(a,"position",!1)},l.positionNodeAt=function(a,b,c,d){var g,h=p.nodes[f.id],i={id:null,y:1/0},j=f.findParent(a),k=p.nodes[j.id],m=p.nodes[a],n=function(b,c,d){var e=b.x<c.x&&d<b.x,g=b.x>c.x&&b.x<d;return e||g?f.flip(a):!1},o=1,q=function(){return 2===m.level||(m.x-k.x)*(b-k.x)>0},r=!1;return f.startBatch(),2===p.nodes[a].level&&(r=n(h,m,b)),_.each(f.sameSideSiblingIds(a),function(a){var b=p.nodes[a];c<b.y&&b.y<i.y&&(i=b)}),!d&&q()&&l.autoPosition(a),r=f.positionBefore(a,i.id)||r,d&&q()&&(g=b<k.x?k.x-b-m.width+k.width:b-k.x,e("nodeManuallyPositioned"),o=_.max(_.map(j.ideas,function(b){return b.id!==a&&b.attr&&b.attr.position&&b.attr.position[2]||0})),r=f.updateAttr(a,"position",[g,c-k.y,o+1])||r),f.endBatch(),r},l.dropNode=function(a,b,c){var d,e=f.findParent(a);return b===a?!1:c?(d=f.clone(a),d&&f.paste(b,d),!1):b===e.id?l.autoPosition(a):f.changeParent(a,b)},l.setLayoutCalculator=function(a){m=a},l.dropImage=function(a,b,c,d,e,g){var i,j=function(d,e){var h=Math.min(b,300)/b,i=Math.min(c,300)/c,j=Math.min(h,i),k=f.getAttrById(d,"icon");l.setIcon("drag and drop",a,Math.round(b*j),Math.round(c*j),k&&k.position||e,d,g)},k=function(){var a;f.startBatch(),a=f.addSubIdea(h),j(a,"center"),f.endBatch(),l.selectNode(a)};return(i=l.getNodeIdAtPosition(d,e))?j(i,"left"):void k()},l.setLabelGenerator=function(a){g=a,l.rebuildRequired()},l.getReorderBoundary=function(a){var b,c,d,e,g,h,i=function(){return a==f.id},j=function(){return b.id===f.id},k=function(a){return p.nodes[a].x>=p.nodes[f.id].x},l=function(b,d){var e=_.map(b,function(a){return a.y}),f=_.map(b,function(a){return a.y+a.height}),g={minY:_.min(e)-n-p.nodes[a].height,maxY:_.max(f)+n,margin:n};return g.edge=d,"left"===d?g.x=c.x+c.width+n:g.x=c.x-n,g},m=function(b){var d={minY:c.y-n-p.nodes[a].height,maxY:c.y+c.height+n,margin:n};return d.edge=b,"left"===b?d.x=c.x+c.width+n:d.x=c.x-n,d},o=function(){var c=_.map(b.ideas,function(a){return p.nodes[a.id]});return c=_.without(c,p.nodes[a]),_.isEmpty(d)||(c=_.difference(c,d)),c},q=[];return i(a)?!1:(b=f.findParent(a),c=p.nodes[b.id],g=k(a)?"left":"right",h=k(a)?"right":"left",d=_.map(f.sameSideSiblingIds(a),function(a){return p.nodes[a]}),_.isEmpty(d)||q.push(l(d,g)),q.push(m(g)),j()&&(e=o(),_.isEmpty(e)||q.push(l(e,h)),q.push(m(h))),q)},l.focusAndSelect=function(a){l.selectNode(a),l.dispatchEvent("nodeFocusRequested",a)},l.requestContextMenu=function(a,b){return q&&r?(l.dispatchEvent("contextMenuRequested",h,a,b),!0):!1}},jQuery.fn.mapToolbarWidget=function(a){"use strict";var b=["insertIntermediate","scaleUp","scaleDown","addSubIdea","editNode","removeSubIdea","toggleCollapse","addSiblingIdea","undo","redo","copy","cut","paste","resetView","openAttachment","toggleAddLinkMode","activateChildren","activateNodeAndChildren","activateSiblingNodes","editIcon"],c=["updateStyle"];return this.each(function(){var d=jQuery(this),e=!1;a.addEventListener("nodeSelectionChanged",function(){e=!0,d.find(".updateStyle[data-mm-target-property]").val(function(){return a.getSelectedStyle(jQuery(this).data("mm-target-property"))}).change(),e=!1}),a.addEventListener("addLinkModeToggled",function(){d.find(".toggleAddLinkMode").toggleClass("active")}),b.forEach(function(b){d.find("."+b).click(function(){a[b]&&a[b]("toolbar")})}),c.forEach(function(b){d.find("."+b).change(function(){if(!e){var c=jQuery(this);c.data("mm-target-property")&&a[b]("toolbar",c.data("mm-target-property"),c.val())}})})})},jQuery.fn.linkEditWidget=function(a){"use strict";return this.each(function(){var b,c,d,e,f,g,h=jQuery(this);e=h.find(".color"),f=h.find(".lineStyle"),g=h.find(".arrow"),a.addEventListener("linkSelected",function(a,i,j){b=a,h.show(),c=c||h.width(),d=d||h.height(),h.css({top:i.y-.5*d-15+"px",left:i.x-.5*c-15+"px"}),e.val(j.color).change(),f.val(j.lineStyle),g[j.arrow?"addClass":"removeClass"]("active")}),a.addEventListener("mapMoveRequested",function(){h.hide()}),h.find(".delete").click(function(){a.removeLink("mouse",b.ideaIdFrom,b.ideaIdTo),h.hide()}),e.change(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"color",jQuery(this).val())}),f.find("a").click(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"lineStyle",jQuery(this).text())}),g.click(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"arrow",!g.hasClass("active"))}),h.mouseleave(h.hide.bind(h))})},MAPJS.getDataURIAndDimensions=function(a,b){"use strict";var c=function(a){return/^data:image/.test(a)},d=function(a){if(c(a.src))return a.src;var b,d=document.createElement("canvas");return d.width=a.width,d.height=a.height,b=d.getContext("2d"),b.drawImage(a,0,0),d.toDataURL("image/png")},e=jQuery.Deferred(),f=new Image;return f.onload=function(){try{e.resolve({dataUri:d(f),width:f.width,height:f.height})}catch(a){e.reject()}},f.onerror=function(){e.reject()},c(a)||(b?(f.crossOrigin="Anonymous",a=b+encodeURIComponent(a)):e.reject("no-cors")),f.src=a,e.promise()},MAPJS.ImageInsertController=function(a,b){"use strict";var c=observable(this),d=function(a){var b=jQuery.Deferred(),c=new FileReader;return c.onload=function(a){b.resolve(a.target.result)},c.onerror=b.reject,c.onprogress=b.notify,c.readAsDataURL(a),b.promise()};c.insertDataUrl=function(d,e){c.dispatchEvent("imageLoadStarted"),MAPJS.getDataURIAndDimensions(d,a).then(function(a){var d=a.dataUri;b&&(d=b(d)),c.dispatchEvent("imageInserted",d,a.width,a.height,e)},function(a){c.dispatchEvent("imageInsertError",a)})},c.insertFiles=function(a,b){jQuery.each(a,function(a,e){/^image\//.test(e.type)&&jQuery.when(d(e)).done(function(a){c.insertDataUrl(a,b)})})},c.insertHtmlContent=function(a,b){var d=a.match(/img[^>]*src="([^"]*)"/);d&&d.length>0&&_.each(d.slice(1),function(a){c.insertDataUrl(a,b)})}},jQuery.fn.imageDropWidget=function(a){"use strict";return this.on("dragenter dragover",function(a){return a.originalEvent.dataTransfer?!1:void 0}).on("drop",function(b){var c,d=b.originalEvent.dataTransfer;b.stopPropagation(),b.preventDefault(),d&&d.files&&d.files.length>0?a.insertFiles(d.files,b.originalEvent):d&&(c=d.getData("text/html"),a.insertHtmlContent(c,b.originalEvent))}),this},MAPJS.DOMRender={svgPixel:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"></svg>',nodeCacheMark:function(a,b){"use strict";return{title:a.title,icon:a.attr&&a.attr.icon&&_.pick(a.attr.icon,"width","height","position"),collapsed:a.attr&&a.attr.collapsed,level:a.level||b}},dummyTextBox:jQuery("<div>").addClass("mapjs-node").css({position:"absolute",visibility:"hidden"}),dimensionProvider:function(a,b){"use strict";var c,d=jQuery(document).nodeWithId(a.id),e=function(){return MAPJS.DOMRender.svgPixel};return d&&d.length>0&&_.isEqual(d.data("nodeCacheMark"),MAPJS.DOMRender.nodeCacheMark(a,b))?_.pick(d.data(),"width","height"):(d=MAPJS.DOMRender.dummyTextBox,d.attr("mapjs-level",b).appendTo("body").updateNodeContent(a,e),c={width:d.outerWidth(!0),height:d.outerHeight(!0)},d.detach(),c)},layoutCalculator:function(a){"use strict";return MAPJS.calculateLayout(a,MAPJS.DOMRender.dimensionProvider)},fixedLayout:!1},MAPJS.createSVG=function(a){"use strict";return jQuery(document.createElementNS("http://www.w3.org/2000/svg",a||"svg"))},jQuery.fn.getBox=function(){"use strict";var a=this&&this[0];return a?{top:a.offsetTop,left:a.offsetLeft,width:a.offsetWidth,height:a.offsetHeight}:!1},jQuery.fn.getDataBox=function(){"use strict";var a=this.data();return a&&a.width&&a.height?{top:a.y,left:a.x,width:a.width,height:a.height}:this.getBox()},jQuery.fn.animateConnectorToPosition=function(a,b){"use strict";var c=jQuery(this),d=c.data("nodeFrom"),e=c.data("nodeTo"),f=d&&d.getDataBox(),g=e&&e.getDataBox(),h={from:d&&d.getBox(),to:e&&e.getBox()};return b=b||1,f&&g&&h&&h.from.width===f.width&&h.to.width===g.width&&h.from.height===f.height&&h.to.height===g.height&&Math.abs(h.from.top-h.to.top-(f.top-g.top))<b&&Math.abs(h.from.left-h.to.left-(f.left-g.left))<b?(c.animate({left:Math.round(Math.min(f.left,g.left)),top:Math.round(Math.min(f.top,g.top))},a),!0):!1},jQuery.fn.queueFadeOut=function(a){"use strict";var b=this;return b.fadeOut(_.extend({complete:function(){b.is(":focus")&&b.parents("[tabindex]").focus(),b.remove()}},a))},jQuery.fn.queueFadeIn=function(a){"use strict";var b=this;return b.css("opacity",0).animate({opacity:1},_.extend({complete:function(){b.css("opacity","")}},a))},jQuery.fn.updateStage=function(){"use strict";var a=this.data(),b={"min-width":Math.round(a.width-a.offsetX),"min-height":Math.round(a.height-a.offsetY),width:Math.round(a.width-a.offsetX),height:Math.round(a.height-a.offsetY),"transform-origin":"top left",transform:"translate3d("+Math.round(a.offsetX)+"px, "+Math.round(a.offsetY)+"px, 0)"};return a.scale&&1!==a.scale&&(b.transform="scale("+a.scale+") translate("+Math.round(a.offsetX)+"px, "+Math.round(a.offsetY)+"px)"),this.css(b),this},MAPJS.DOMRender.curvedPath=function(a,b){"use strict";var c,d,e,f=function(a,b,c,d,e,f,g,h){var i=e>a?.1:.9,j=1-i;return{from:{x:a+j*c,y:b+.5*d},to:{x:e+i*g,y:f+.5*h},controlPointOffset:0}},g=function(a,b){var c,d=10,e=b.top+.5*b.height,g=a.top+.5*a.height;return Math.abs(g-e)+d<Math.max(b.height,.75*a.height)?f(a.left,a.top,a.width,a.height,b.left,b.top,b.width,b.height):(c=a.left<b.left?0:1,{from:{x:a.left+.5*a.width,y:a.top+.5*a.height},to:{x:b.left+c*b.width,y:b.top+.5*b.height},controlPointOffset:.75})},h={left:Math.min(a.left,b.left),top:Math.min(a.top,b.top)};return h.width=Math.max(a.left+a.width,b.left+b.width,h.left+1)-h.left,h.height=Math.max(a.top+a.height,b.top+b.height,h.top+1)-h.top,c=g(a,b),d=c.controlPointOffset*(c.from.y-c.to.y),e=1.5*Math.min(b.height,a.height),d=Math.max(-e,Math.min(e,d)),{d:"M"+Math.round(c.from.x-h.left)+","+Math.round(c.from.y-h.top)+"Q"+Math.round(c.from.x-h.left)+","+Math.round(c.to.y-d-h.top)+" "+Math.round(c.to.x-h.left)+","+Math.round(c.to.y-h.top),position:h}},MAPJS.DOMRender.straightPath=function(a,b){"use strict";var c=function(a,b){var c,d,e,f,g,h,i,j=[{x:a.left+.5*a.width,y:a.top},{x:a.left+a.width,y:a.top+.5*a.height},{x:a.left+.5*a.width,y:a.top+a.height},{x:a.left,y:a.top+.5*a.height}],k=[{x:b.left+.5*b.width,y:b.top},{x:b.left+b.width,y:b.top+.5*b.height},{x:b.left+.5*b.width,y:b.top+b.height},{x:b.left,y:b.top+.5*b.height}],l=1/0;for(c=0;c<j.length;c+=1)for(d=0;d<k.length;d+=1)g=j[c].x-k[d].x,h=j[c].y-k[d].y,i=g*g+h*h,l>i&&(e=c,f=d,l=i);return{from:j[e],to:k[f]}},d={left:Math.min(a.left,b.left),top:Math.min(a.top,b.top)},e=c(a,b);return d.width=Math.max(a.left+a.width,b.left+b.width,d.left+1)-d.left,d.height=Math.max(a.top+a.height,b.top+b.height,d.top+1)-d.top,{d:"M"+Math.round(e.from.x-d.left)+","+Math.round(e.from.y-d.top)+"L"+Math.round(e.to.x-d.left)+","+Math.round(e.to.y-d.top),conn:e,position:d}},MAPJS.DOMRender.nodeConnectorPath=MAPJS.DOMRender.curvedPath,MAPJS.DOMRender.linkConnectorPath=MAPJS.DOMRender.straightPath,jQuery.fn.updateConnector=function(a){"use strict";return jQuery.each(this,function(){var b,c,d,e,f,g=jQuery(this),h=g.data("nodeFrom"),i=g.data("nodeTo");return h&&i&&0!==h.length&&0!==i.length?(a?(d=h.getDataBox(),e=i.getDataBox()):(d=h.getBox(),e=i.getBox()),f={from:d,to:e},void(_.isEqual(f,g.data("changeCheck"))||(g.data("changeCheck",f),b=MAPJS.DOMRender.nodeConnectorPath(d,e),c=g.find("path"),g.css(b.position),0===c.length&&(c=MAPJS.createSVG("path").attr("class","mapjs-connector").appendTo(g)),c.attr("d",b.d)))):void g.hide()})},jQuery.fn.updateLink=function(){"use strict";return jQuery.each(this,function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=jQuery(this),o=n.data("nodeFrom"),p=n.data("nodeTo"),q=n.find("path.mapjs-link"),r=n.find("path.mapjs-link-hit"),s=n.find("path.mapjs-arrow"),t=Math.tan(Math.PI/9),u={dashed:"8, 8",solid:""},v=_.pick(n.data(),"lineStyle","arrow","color");return o&&p&&0!==o.length&&0!==p.length?(b=o.getBox(),c=p.getBox(),d={from:b,to:c,attrs:v},void(_.isEqual(d,n.data("changeCheck"))||(n.data("changeCheck",d),a=MAPJS.DOMRender.linkConnectorPath(b,c),n.css(a.position),0===q.length&&(q=MAPJS.createSVG("path").attr("class","mapjs-link").appendTo(n)),q.attr({d:a.d,"stroke-dasharray":u[v.lineStyle]}).css("stroke",v.color),0===r.length&&(r=MAPJS.createSVG("path").attr("class","mapjs-link-hit").appendTo(n)),r.attr({d:a.d}),v.arrow?(0===s.length&&(s=MAPJS.createSVG("path").attr("class","mapjs-arrow").appendTo(n)),i=14,l=a.conn.to.x-a.conn.from.x,m=a.conn.to.y-a.conn.from.y,0===l?(j=0>m?-1:1,e=a.conn.to.x+i*Math.sin(t)*j,g=a.conn.to.x-i*Math.sin(t)*j,f=a.conn.to.y-i*Math.cos(t)*j,h=a.conn.to.y-i*Math.cos(t)*j):(k=m/l,a.conn.from.x<a.conn.to.x&&(i=-i),e=a.conn.to.x+(1-k*t)*i/Math.sqrt((1+k*k)*(1+t*t)),f=a.conn.to.y+(k+t)*i/Math.sqrt((1+k*k)*(1+t*t)),g=a.conn.to.x+(1+k*t)*i/Math.sqrt((1+k*k)*(1+t*t)),h=a.conn.to.y+(k-t)*i/Math.sqrt((1+k*k)*(1+t*t))),s.attr("d","M"+Math.round(e-a.position.left)+","+Math.round(f-a.position.top)+"L"+Math.round(a.conn.to.x-a.position.left)+","+Math.round(a.conn.to.y-a.position.top)+"L"+Math.round(g-a.position.left)+","+Math.round(h-a.position.top)+"Z").css("fill",v.color).show()):s.hide()))):void n.hide()})},jQuery.fn.addNodeCacheMark=function(a){"use strict";this.data("nodeCacheMark",MAPJS.DOMRender.nodeCacheMark(a))},jQuery.fn.updateNodeContent=function(a,b){"use strict";var c=25,d=jQuery(this),e=function(){var a=d.find("[data-mapjs-role=title]");return 0===a.length&&(a=jQuery("<span>").attr("data-mapjs-role","title").appendTo(d)),a},f=function(a){var b=MAPJS.URLHelper.getLink(a),c=d.find("a.mapjs-hyperlink");return b?(0===c.length&&(c=jQuery('<a target="_blank" class="mapjs-hyperlink"></a>').appendTo(d)),void c.attr("href",b).show()):void c.hide()},g=function(a){var b=d.find(".mapjs-label");return a||0===a?(0===b.length&&(b=jQuery('<span class="mapjs-label"></span>').appendTo(d)),void b.text(a).show()):void b.hide()},h=function(){var b=a.attr&&a.attr.attachment,c=d.find("a.mapjs-attachment");return b?(0===c.length&&(c=jQuery('<a href="#" class="mapjs-attachment"></a>').appendTo(d).click(function(){d.trigger("attachment-click")})),void c.show()):void c.hide()},i=function(a){var b,f=MAPJS.URLHelper.stripLink(a)||(a.length<c?a:a.substring(0,c)+"..."),g=MAPJS.DOMRender.nodeTextPadding||11,h=e(),i=h[0];h.text(f.trim()),d.data("title",a),h.css({"max-width":"","min-width":""}),i.scrollWidth-g>i.offsetWidth?h.css("max-width",i.scrollWidth+"px"):(b=i.offsetHeight,h.css("min-width",h.css("max-width")),i.offsetHeight===b&&h.css("min-width",""))},j=function(){a.attr&&a.attr.collapsed?d.addClass("collapsed"):d.removeClass("collapsed")},k=function(a){var b=Color(a).mix(Color("#EEEEEE")).luminosity();return.5>b?"mapjs-node-dark":.9>b?"mapjs-node-light":"mapjs-node-white"},l=function(){var b=a.attr&&a.attr.style&&a.attr.style.background;("false"===b||"transparent"===b)&&(b=!1),d.removeClass("mapjs-node-dark mapjs-node-white mapjs-node-light"),b?(d.css("background-color",b),d.addClass(k(b))):d.css("background-color","")},m=function(a){var c,f,g,h,i=e(),j={"min-height":"","min-width":"","background-image":"","background-repeat":"","background-size":"","background-position":""},k={"margin-top":"","margin-left":""};d.css({padding:""}),a&&(h=parseInt(d.css("padding-left"),10),c=i.outerHeight(),f=i.outerWidth(),g=parseInt(i.css("max-width"),10),_.extend(j,{"background-image":'url("'+(b?b(a.url):a.url)+'")',"background-repeat":"no-repeat","background-size":a.width+"px "+a.height+"px","background-position":"center center"}),"top"===a.position||"bottom"===a.position?("top"===a.position?j["background-position"]="center "+h+"px":MAPJS.DOMRender.fixedLayout?j["background-position"]="center "+(h+c)+"px":j["background-position"]="center "+a.position+" "+h+"px",j["padding-"+a.position]=a.height+2*h,j["min-width"]=a.width,a.width>g&&(k["margin-left"]=(a.width-g)/2)):"left"===a.position||"right"===a.position?("left"===a.position?j["background-position"]=h+"px center":MAPJS.DOMRender.fixedLayout?j["background-position"]=f+2*h+"px center ":j["background-position"]=a.position+" "+h+"px center",j["padding-"+a.position]=a.width+2*h,a.height>c&&(k["margin-top"]=(a.height-c)/2,j["min-height"]=a.height)):(a.height>c&&(k["margin-top"]=(a.height-c)/2,j["min-height"]=a.height),j["min-width"]=a.width,a.width>g&&(k["margin-left"]=(a.width-g)/2))),d.css(j),i.css(k)};return d.attr("mapjs-level",a.level),i(a.title),f(a.title),g(a.label),h(),d.data({x:Math.round(a.x),y:Math.round(a.y),width:Math.round(a.width),height:Math.round(a.height),nodeId:a.id}).addNodeCacheMark(a),l(),m(a.attr&&a.attr.icon),j(),d},jQuery.fn.placeCaretAtEnd=function(){"use strict";var a,b,c,d=this[0];window.getSelection&&document.createRange?(a=document.createRange(),a.selectNodeContents(d),a.collapse(!1),b=window.getSelection(),b.removeAllRanges(),b.addRange(a)):document.body.createTextRange&&(c=document.body.createTextRange(),c.moveToElementText(d),c.collapse(!1),c.select())},jQuery.fn.selectAll=function(){"use strict";var a,b,c,d=this[0];window.getSelection&&document.createRange?(a=document.createRange(),a.selectNodeContents(d),b=window.getSelection(),b.removeAllRanges(),b.addRange(a)):document.body.createTextRange&&(c=document.body.createTextRange(),c.moveToElementText(d),c.select())},jQuery.fn.innerText=function(){"use strict";var a=this.html(),b=/<br\/?>/.test(a),c=/<div>/.test(a);return c&&this[0].innerText?this[0].innerText.trim():b?a.replace(/<br\/?>/gi,"\n").replace(/(<([^>]+)>)/gi,""):this.text()},jQuery.fn.editNode=function(a){"use strict";var b=this,c=this.find("[data-mapjs-role=title]"),d=this.data("title"),e=c.text(),f=jQuery.Deferred(),g=function(){l(),c.css("word-break",""),c.removeAttr("contenteditable"),b.shadowDraggable()},h=function(){var a=c.innerText();return a===d?i():(g(),void f.resolve(a))},i=function(){g(),c.text(e),f.reject()},j=function(a){var b=13,e=27,f=9,g=83,j=90;a.shiftKey&&a.which===b||(a.which===b?(h(),a.stopPropagation()):a.which===e?(i(),a.stopPropagation()):a.which===f||a.which===g&&(a.metaKey||a.ctrlKey)&&!a.altKey?(h(),a.preventDefault()):a.shiftKey||a.which!==j||!a.metaKey&&!a.ctrlKey||a.altKey||(c.text()===d&&i(),a.stopPropagation()))},k=function(){c.on("blur",h).on("keydown",j)},l=function(){c.off("blur",h).off("keydown",j)};return k(),d!==e&&c.css("word-break","break-all"),c.text(d).attr("contenteditable",!0).focus(),a?c.selectAll():d&&c.placeCaretAtEnd(),b.shadowDraggable({disable:!0}),f.promise()},jQuery.fn.updateReorderBounds=function(a,b){"use strict";var c=this;return a?(c.show(),c.attr("mapjs-edge",a.edge),void c.css({top:b.y+b.height/2-c.height()/2,left:a.x-("left"===a.edge?c.width():0)})):void c.hide()},function(){"use strict";var a=function(a){return a.replace(/[^A-Za-z0-9_-]/g,"_")},b=function(b){return a("connector_"+b.from+"_"+b.to)},c=function(b){return a("link_"+b.ideaIdFrom+"_"+b.ideaIdTo)},d=function(b){return a("node_"+b)};jQuery.fn.createNode=function(a){return jQuery("<div>").attr({id:d(a.id),tabindex:0,"data-mapjs-role":"node"}).css({display:"block",position:"absolute"}).addClass("mapjs-node").appendTo(this)},jQuery.fn.createConnector=function(a){return MAPJS.createSVG().attr({id:b(a),"data-mapjs-role":"connector","class":"mapjs-draw-container"}).data({nodeFrom:this.nodeWithId(a.from),nodeTo:this.nodeWithId(a.to)}).appendTo(this)},jQuery.fn.createLink=function(a){var b=_.extend({color:"red",lineStyle:"dashed"},a.attr&&a.attr.style);return MAPJS.createSVG().attr({id:c(a),"data-mapjs-role":"link","class":"mapjs-draw-container"}).data({nodeFrom:this.nodeWithId(a.ideaIdFrom),nodeTo:this.nodeWithId(a.ideaIdTo)}).data(b).appendTo(this)},jQuery.fn.nodeWithId=function(a){return this.find("#"+d(a))},jQuery.fn.findConnector=function(a){return this.find("#"+b(a))},jQuery.fn.findLink=function(a){return this.find("#"+c(a))},jQuery.fn.createReorderBounds=function(){var a=jQuery("<div>").attr({"data-mapjs-role":"reorder-bounds","class":"mapjs-reorder-bounds"}).hide().css("position","absolute").appendTo(this);return a}}(),MAPJS.DOMRender.viewController=function(a,b,c,d,e,f){"use strict";var g,h=b.parent(),i=jQuery(),j=jQuery(),k={duration:400,queue:"nodeQueue",easing:"linear"},l=a.isEditingEnabled()?b.createReorderBounds():jQuery("<div>"),m=function(){return g?g:g={left:h.scrollLeft(),top:h.scrollTop(),innerWidth:h.innerWidth(),innerHeight:h.innerHeight()}},n=function(a,c){var d=b.data(),e=m();return{x:d.scale*(a+d.offsetX)-e.left,y:d.scale*(c+d.offsetY)-e.top}},o=function(a,c){var d=b.data(),e=m();return{x:(e.left+a)/d.scale-d.offsetX,y:(e.top+c)/d.scale-d.offsetY}},p=function(){var a=jQuery(this);a.css({left:a.data("x"),top:a.data("y")}).trigger("mapjs:move")},q=function(){var a=jQuery(this);a.clearQueue(k.queue).animate({left:a.data("x"),top:a.data("y"),opacity:1},_.extend({complete:function(){a.css("opacity",""),a.each(p)}},k)).trigger("mapjs:animatemove")},r=function(a,c){var d=b.data(),e=!1;a<-1*d.offsetX&&(d.width=d.width-d.offsetX-a,d.offsetX=-1*a,e=!0),c<-1*d.offsetY&&(d.height=d.height-d.offsetY-c,d.offsetY=-1*c,e=!0),a>d.width-d.offsetX&&(d.width=d.offsetX+a,e=!0),c>d.height-d.offsetY&&(d.height=d.offsetY+c,e=!0),e&&b.updateStage()},s=function(){return jQuery(this).each(function(){var a=jQuery(this).data(),b=MAPJS.DOMRender.stageMargin||{top:0,left:0,bottom:0,right:0};r(a.x-b.left,a.y-b.top),r(a.x+a.width+b.right,a.y+a.height+b.bottom)})},t=function(a,c,d){var e,f,g=b.data(),i={x:h.innerWidth()/2,y:h.innerHeight()/2},j=MAPJS.DOMRender.stageVisibilityMargin||{top:0,left:0,bottom:0,right:0};r(a-i.x/g.scale,c-i.y/g.scale),r(a+i.x/g.scale-j.left,c+i.y/g.scale-j.top),e=g.scale*(a+g.offsetX)-i.x,f=g.scale*(c+g.offsetY)-i.y,h.finish(),d?h.animate({scrollLeft:e,scrollTop:f},{duration:400}):(h.scrollLeft(e),h.scrollTop(f))},u=function(){return o(h.innerWidth()/2,h.innerHeight()/2)},v=function(a){if(a&&0!==a.length){h.finish();var b=a.data(),c=n(b.x,b.y),d=n(b.x+b.width,b.y+b.height),e={},f=MAPJS.DOMRender.stageVisibilityMargin||{top:10,left:10,bottom:10,right:10};c.x-f.left<0?e.scrollLeft=h.scrollLeft()+c.x-f.left:d.x+f.right>h.innerWidth()&&(e.scrollLeft=h.scrollLeft()+d.x-h.innerWidth()+f.right),c.y-f.top<0?e.scrollTop=h.scrollTop()+c.y-f.top:d.y+f.bottom>h.innerHeight()&&(e.scrollTop=h.scrollTop()+d.y-h.innerHeight()+f.bottom),_.isEmpty(e)||h.animate(e,{duration:100})}},w=function(a){var b,c=a&&a.gesture&&a.gesture.center||a,d=h.offset();return c&&(b={x:c.pageX-d.left,y:c.pageY-d.top},b.x>=0&&b.x<=h.innerWidth()&&b.y>=0&&b.y<=h.innerHeight())?b:void 0},x=function(a){var b=w(a);return b?o(b.x,b.y):void 0},y=function(){(A||A===!1)&&(jQuery(".mapjs-node").removeClass("droppable"),A=void 0)},z=function(a){b.nodeWithId(a).addClass("droppable"),A=a},A=!1,B=function(a,b){if(_.isEmpty(a))return!1;if(!b)return!1;var c=function(a){var c=b.x;return"right"===a.edge&&(c+=b.width),Math.abs(c-a.x)<2*a.margin&&b.y<a.maxY&&b.y>a.minY};return _.find(a,c)};h.on("scroll",function(){g=void 0}),d&&d.addEventListener("imageInserted",function(b,c,d,e){var f=x(e);a.dropImage(b,c,d,f&&f.x,f&&f.y)}),a.addEventListener("nodeCreated",function(d){var f,g=b.createNode(d).queueFadeIn(k).updateNodeContent(d,e).on("tap",function(b){var c=b.gesture&&b.gesture.srcEvent||b;c.button&&-1!==c.button||(a.clickNode(d.id,c),b&&b.stopPropagation(),b&&b.gesture&&b.gesture.stopPropagation())}).on("doubletap",function(b){return b&&(b.stopPropagation(),b.gesture&&b.gesture.stopPropagation()),a.isEditingEnabled()?void a.editNode("mouse"):void a.toggleCollapse("mouse")}).on("attachment-click",function(){a.openAttachment("mouse",d.id)}).each(s).each(p).on("mm:start-dragging mm:start-dragging-shadow",function(){a.selectNode(d.id),f=a.getReorderBoundary(d.id),g.addClass("dragging")}).on("mm:drag",function(b){var c,e,h=x(b),i=b.currentPosition&&x({pageX:b.currentPosition.left,pageY:b.currentPosition.top}),j=b&&b.gesture&&b.gesture.srcEvent&&b.gesture.srcEvent.shiftKey;return h?(c=a.getNodeIdAtPosition(h.x,h.y),j||c||!i?l.hide():(i.width=g.outerWidth(),i.height=g.outerHeight(),e=B(f,i),l.updateReorderBounds(e,i)),void(c&&c!==d.id?c!==A&&(y(),c&&z(c)):y())):void y()}).on("contextmenu",function(b){return a.selectNode(d.id),a.requestContextMenu(b.pageX,b.pageY)?(b.preventDefault(),!1):void 0}).on("mm:stop-dragging",function(b){g.removeClass("dragging"),l.hide();var c,e,h,i,j,k=b&&b.gesture&&b.gesture.srcEvent&&b.gesture.srcEvent.shiftKey,m=x(b);return y(),m?(c=a.getNodeIdAtPosition(m.x,m.y),e=x({pageX:b.finalPosition.left,pageY:b.finalPosition.top}),c&&c!==d.id?h=a.dropNode(d.id,c,!!k):d.level>1?(e.width=g.outerWidth(),e.height=g.outerHeight(),i=!!k||!B(f,e),h=a.positionNodeAt(d.id,e.x,e.y,i)):1===d.level&&b.gesture?(j=u(),j.x-=b.gesture.deltaX||0,j.y-=b.gesture.deltaY||0,t(j.x,j.y,!0),h=!0):h=!1,h):void 0}).on("mm:cancel-dragging",function(){y(),g.removeClass("dragging"),l.hide()});c&&g.on("hold",function(b){var c=b.gesture&&b.gesture.srcEvent||b;return a.clickNode(d.id,c),a.requestContextMenu(b.gesture.center.pageX,b.gesture.center.pageY)?(b.preventDefault(),b.gesture&&(b.gesture.preventDefault(),b.gesture.stopPropagation()),!1):void 0}),g.css("min-width",g.css("width")),a.isEditingEnabled()&&g.shadowDraggable()}),a.addEventListener("nodeSelectionChanged",function(a,c){var d=b.nodeWithId(a);c?(d.addClass("selected"),v(d)):d.removeClass("selected")}),a.addEventListener("nodeRemoved",function(a){b.nodeWithId(a.id).queueFadeOut(k)}),a.addEventListener("nodeMoved",function(a){var c=m(),d=b.nodeWithId(a.id).data({x:Math.round(a.x),y:Math.round(a.y)}).each(s),e=n(Math.round(a.x),Math.round(a.y)),f=n(Math.round(a.x+a.width),Math.round(a.y+a.height));f.x<0||f.y<0||e.x>c.innerWidth||e.y>c.innerHeight?d.each(p):d.each(q)}),a.addEventListener("nodeTitleChanged nodeAttrChanged nodeLabelChanged",function(a){b.nodeWithId(a.id).updateNodeContent(a,e)}),a.addEventListener("connectorCreated",function(a){var c=b.createConnector(a).queueFadeIn(k).updateConnector(!0);b.nodeWithId(a.from).add(b.nodeWithId(a.to)).on("mapjs:move",function(){c.updateConnector(!0)}).on("mm:drag",function(){c.updateConnector()}).on("mapjs:animatemove",function(){i=i.add(c)})}),a.addEventListener("connectorRemoved",function(a){b.findConnector(a).queueFadeOut(k)}),a.addEventListener("linkCreated",function(c){var d=b.createLink(c).queueFadeIn(k).updateLink();d.find(".mapjs-link-hit").on("tap",function(b){a.selectLink("mouse",c,{x:b.gesture.center.pageX,y:b.gesture.center.pageY}),b.stopPropagation(),b.gesture.stopPropagation()}),b.nodeWithId(c.ideaIdFrom).add(b.nodeWithId(c.ideaIdTo)).on("mapjs:move mm:drag",function(){d.updateLink()}).on("mapjs:animatemove",function(){j=j.add(d)})}),a.addEventListener("linkRemoved",function(a){b.findLink(a).queueFadeOut(k)}),a.addEventListener("mapScaleChanged",function(a){var c=b.data("scale"),d=Math.max(Math.min(c*a,5),.2),e=u();c!==d&&(b.data("scale",d).updateStage(),t(e.x,e.y))}),a.addEventListener("nodeVisibilityRequested",function(c){var d=c||a.getCurrentlySelectedIdeaId(),e=b.nodeWithId(d);e&&(v(e),h.finish())}),a.addEventListener("nodeFocusRequested",function(a){var c=b.nodeWithId(a).data(),d=c.x+c.width/2,e=c.y+c.height/2;1!==b.data("scale")&&b.data("scale",1).updateStage(),t(d,e,!0)}),a.addEventListener("mapViewResetRequested",function(){b.data({scale:1,height:0,width:0,offsetX:0,offsetY:0}).updateStage(),b.children().andSelf().finish(k.queue),jQuery(b).find(".mapjs-node").each(s),jQuery(b).find("[data-mapjs-role=connector]").updateConnector(!0),jQuery(b).find("[data-mapjs-role=link]").updateLink(),t(0,0),h.focus()}),a.addEventListener("layoutChangeStarting",function(){g=void 0,b.children().finish(k.queue),b.finish(k.queue)}),a.addEventListener("layoutChangeComplete",function(){var c=jQuery(),d=jQuery();i.each(function(){jQuery(this).animateConnectorToPosition(k,2)||(c=c.add(this))}),j.each(function(){jQuery(this).animateConnectorToPosition(k,2)||(d=d.add(this))}),i=jQuery(),j=jQuery(),b.animate({opacity:1},_.extend({progress:function(){c.updateConnector(),d.updateLink()}},k)),v(b.nodeWithId(a.getCurrentlySelectedIdeaId())),b.children().dequeue(k.queue),b.dequeue(k.queue)}),f&&f.inlineEditingDisabled||a.addEventListener("nodeEditRequested",function(c,d,e){var f=b.nodeWithId(c);a.setInputEnabled(!1),h.finish(),f.editNode(d).done(function(b){a.setInputEnabled(!0),a.updateTitle(c,b,e),f.focus()}).fail(function(){a.setInputEnabled(!0),e&&a.undo("internal"),f.focus()})}),a.addEventListener("addLinkModeToggled",function(a){a?b.addClass("mapjs-add-link"):b.removeClass("mapjs-add-link")}),a.addEventListener("linkAttrChanged",function(a){var c=_.extend({arrow:!1},a.attr&&a.attr.style);b.findLink(a).data(c).updateLink()}),a.addEventListener("activatedNodesChanged",function(a,c){_.each(a,function(a){b.nodeWithId(a).addClass("activated")}),_.each(c,function(a){b.nodeWithId(a).removeClass("activated")})})},jQuery.fn.scrollWhenDragging=function(a){"use strict";return this.each(function(){var b,c=$(this);c.on("dragstart",function(){a()&&(b={top:c.scrollTop(),left:c.scrollLeft()})}).on("drag",function(a){a.gesture&&b&&(c.scrollTop(b.top-a.gesture.deltaY),c.scrollLeft(b.left-a.gesture.deltaX))}).on("dragend",function(){b=void 0})})},$.fn.domMapWidget=function(a,b,c,d,e,f,g,h){"use strict";var i={"return":"addSiblingIdea","shift+return":"addSiblingIdeaBefore","del backspace":"removeSubIdea","tab insert":"addSubIdea",left:"selectNodeLeft",up:"selectNodeUp",right:"selectNodeRight","shift+right":"activateNodeRight","shift+left":"activateNodeLeft","meta+right ctrl+right meta+left ctrl+left":"flip","shift+up":"activateNodeUp","shift+down":"activateNodeDown",down:"selectNodeDown","space f2":"editNode",f:"toggleCollapse","c meta+x ctrl+x":"cut","p meta+v ctrl+v":"paste","y meta+c ctrl+c":"copy","u meta+z ctrl+z":"undo","shift+tab":"insertIntermediate","Esc 0 meta+0 ctrl+0":"resetView","r meta+shift+z ctrl+shift+z meta+y ctrl+y":"redo","meta+plus ctrl+plus z":"scaleUp","meta+minus ctrl+minus shift+z":"scaleDown","meta+up ctrl+up":"moveUp","meta+down ctrl+down":"moveDown","ctrl+shift+v meta+shift+v":"pasteStyle",Esc:"cancelCurrentAction"},j={"[":"activateChildren","{":"activateNodeAndChildren","=":"activateSiblingNodes",".":"activateSelectedNode","/":"toggleCollapse",a:"openAttachment",i:"editIcon"},k=!0,l=this;return b.addEventListener("inputEnabledChanged",function(a,b){k=a,a&&!b&&l.focus()}),this.each(function(){
var a=$(this),l=$("<div>").css({position:"relative"}).attr("data-mapjs-role","stage").appendTo(a).data({offsetX:a.innerWidth()/2,offsetY:a.innerHeight()/2,width:a.innerWidth()-20,height:a.innerHeight()-20,scale:1}).updateStage(),m=!1;a.css("overflow","auto").attr("tabindex",1),b.isEditingEnabled()&&(e||a).simpleDraggableContainer(),c?a.on("doubletap",function(a){return b.requestContextMenu(a.gesture.center.pageX,a.gesture.center.pageY)?(a.preventDefault(),a.gesture.preventDefault(),!1):void 0}).on("pinch",function(a){if(a&&a.gesture&&a.gesture.scale){a.preventDefault(),a.gesture.preventDefault();var c=a.gesture.scale;m&&(c/=m),Math.abs(c-1)<.05||(m=a.gesture.scale,b.scale("touch",c,{x:a.gesture.center.pageX-l.data("offsetX"),y:a.gesture.center.pageY-l.data("offsetY")}))}}).on("gestureend",function(){m=!1}):(a.scrollWhenDragging(b.getInputEnabled),a.on("mousedown",function(b){b.target!==a[0]&&a.css("overflow","hidden")}),jQuery(document).on("mouseup",function(){"auto"!==a.css("overflow")&&a.css("overflow","auto")}),a.imageDropWidget(d)),MAPJS.DOMRender.viewController(b,l,c,d,f,h),_.each(i,function(c,d){a.keydown(d,function(a){k&&(a.stopImmediatePropagation(),a.preventDefault(),b[c]("keyboard"))})}),c||jQuery(window).on("resize",function(){b.resetView()}),jQuery(window).on("orientationchange",function(){g?b.centerOnNode(b.getSelectedNodeId()):b.resetView()}),jQuery(document).on("keydown",function(a){var c,d={"U+003D":"scaleUp","U+002D":"scaleDown",61:"scaleUp",173:"scaleDown"};a&&!a.altKey&&(a.ctrlKey||a.metaKey)&&(a.originalEvent&&a.originalEvent.keyIdentifier?c=d[a.originalEvent.keyIdentifier]:"MozPrintableKey"===a.key&&(c=d[a.which]),c&&k&&(a.preventDefault(),b[c]("keyboard")))}).on("wheel mousewheel",function(b){var c=b.originalEvent.deltaX||-1*b.originalEvent.wheelDeltaX;0>c&&0===a.scrollLeft()&&b.preventDefault(),c>0&&a[0].scrollWidth-a.width()-a.scrollLeft()===0&&b.preventDefault()}),a.on("keypress",function(a){if(k&&!/INPUT|TEXTAREA/.test(a&&a.target&&a.target.tagName)){var c=a.charCode||a.keyCode,d=String.fromCharCode(c),e=j[d];e?(a.preventDefault(),b[e]("keyboard")):Number(d)<=9&&Number(d)>=1&&(a.preventDefault(),b.activateLevel("keyboard",Number(d)+1))}})})};
//# sourceMappingURL=mindmup-mapjs.min.js.map